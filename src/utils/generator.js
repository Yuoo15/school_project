//—Å –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä–æ–º –º–Ω–µ –ø–æ–º–æ–≥ –∏–∏
function shuffleArray(arr) {
  const a = [...(arr || [])];
  for (let i = a.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [a[i], a[j]] = [a[j], a[i]];
  }
  return a;
}

export function generateAllSchedulesBacktracking({
  classes = [],
  subjects = [],
  teachers = [],
  settings = {},
  timeLimitMs = 60000,
  maxAttempts = 100000,
} = {}) {
  const start = Date.now();

  const DAYS = 5;
  const periods = Number(settings?.periodsPerDay ?? 8);

  console.log(`\nüéØ –ì–ï–ù–ï–†–ê–¶–ò–Ø –° –ì–†–£–ü–ü–ò–†–û–í–ö–û–ô –ü–†–ï–î–ú–ï–¢–û–í`);
  console.log(`üìö –ö–ª–∞—Å—Å–æ–≤: ${classes.length}, –£—á–∏—Ç–µ–ª–µ–π: ${teachers.length}\n`);

  const bySubject = Object.fromEntries((subjects || []).map(s => [s.id, s]));
  const teacherMap = Object.fromEntries((teachers || []).map(t => [t.id, t]));

  const teachersBySubject = {};
  for (const s of subjects) {
    teachersBySubject[s.id] = teachers.filter(t => t.subjects?.includes(s.id));
  }

  // üÜï –ì–†–£–ü–ü–´ –ü–†–ï–î–ú–ï–¢–û–í
  const subjectGroups = {
    math: ['algebra', 'geometry'],
    physed: ['culture', 'pe'],
    languages: ['rus', 'rus_lit', 'rus_lit2', 'kaz_lit', 'eng'],
    endOfDay: ['class_hour', 'religion', 'global_comp']
  };

  function getSubjectGroup(subjectId) {
    for (const [group, subjects] of Object.entries(subjectGroups)) {
      if (subjects.includes(subjectId)) return group;
    }
    return null;
  }

  function getClassLevel(classId) {
    const num = parseInt(String(classId).replace(/\D/g, ''), 10);
    if (num >= 10) return 'senior';
    if (num >= 7) return 'middle';
    return 'junior';
  }

  function hoursForClass(subject, classId) {
    if (!subject) return 0;
    const h = subject.hoursPerWeek;
    if (h == null) return 0;
    if (typeof h === 'number') return Number(h);
    if (typeof h === 'object') {
      const classNum = parseInt(String(classId).replace(/\D/g, ''), 10);
      return Number(h[classNum] ?? h.default ?? 0);
    }
    return Number(h) || 0;
  }

  // –§–ê–ó–ê 1: –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
  function generateBase() {
    console.log(`‚ö° –§–ê–ó–ê 1: –ë–∞–∑–æ–≤–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ`);
    
    const teacherOccupied = {};
    teachers.forEach(t => {
      teacherOccupied[t.id] = Array.from({ length: DAYS }, () => Array(periods).fill(false));
    });

    const result = {};

    for (const cls of classes) {
      const classId = cls.id;
      const classLevel = getClassLevel(classId);
      const lessonsPerDay = Number(cls?.lessonsPerDay ?? 7);

      const subjectsForClass = subjects.filter(s => {
        if (classLevel === 'middle' && s.id === 'nvp') return false;
        if (classLevel !== 'senior' && s.id === 'law') return false;
        return hoursForClass(s, classId) > 0;
      });

      const remaining = {};
      subjectsForClass.forEach(s => {
        remaining[s.id] = hoursForClass(s, classId);
      });

      const totalRequired = Object.values(remaining).reduce((a, b) => a + b, 0);
      
      if (totalRequired === 0) {
        result[classId] = Array.from({ length: DAYS }, () => Array(periods).fill(null));
        continue;
      }

      if (totalRequired > DAYS * periods) {
        return null;
      }

      const grid = Array.from({ length: DAYS }, () => Array(periods).fill(null));
      const perDaySubject = Array.from({ length: DAYS }, () => ({}));
      const perDayGroup = Array.from({ length: DAYS }, () => ({})); // üÜï —Å—á—ë—Ç—á–∏–∫ –≥—Ä—É–ø–ø

      function canPlaceBase(subId, teacherId, d, p) {
        if (!subId || !teacherId) return false;
        if (remaining[subId] <= 0) return false;
        if (!teacherMap[teacherId]?.subjects?.includes(subId)) return false;
        if (teacherOccupied[teacherId]?.[d]?.[p]) return false;
        if (grid[d][p]) return false;
        
        // ‚ùå –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ–¥—Ä—è–¥
        if (p > 0 && grid[d][p - 1]?.subjectId === subId) return false;
        
        // üÜï ‚ùå –î–≤–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã –ø–æ–¥—Ä—è–¥
        const group = getSubjectGroup(subId);
        if (group && p > 0) {
          const prevLesson = grid[d][p - 1];
          if (prevLesson && getSubjectGroup(prevLesson.subjectId) === group) {
            return false;
          }
        }
        
        // ‚ùå –ë–æ–ª—å—à–µ 3 —É—Ä–æ–∫–æ–≤ –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞ –≤ –¥–µ–Ω—å
        const countToday = perDaySubject[d][subId] || 0;
        if (countToday >= 3) return false;

        // üÜï ‚ùå –ë–æ–ª—å—à–µ 3 —É—Ä–æ–∫–æ–≤ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã –≤ –¥–µ–Ω—å (–º–∞—Ç–µ–º–∞—Ç–∏–∫–∞!)
        if (group) {
          const groupCountToday = perDayGroup[d][group] || 0;
          if (groupCountToday >= 3) return false;
        }

        // ‚ùå –§–∏–∑-—Ä–∞: —Ç–æ–ª—å–∫–æ 1 —É—Ä–æ–∫ –≤ –¥–µ–Ω—å
        const physEd = ['culture', 'pe'];
        if (physEd.includes(subId)) {
          const physCount = grid[d].filter(c => c && physEd.includes(c.subjectId)).length;
          if (physCount >= 1) return false;
        }

        return true;
      }

      let allSubjects = [];
      for (const sid of Object.keys(remaining)) {
        for (let i = 0; i < remaining[sid]; i++) {
          allSubjects.push(sid);
        }
      }
      allSubjects = shuffleArray(allSubjects);

      for (let d = 0; d < DAYS && allSubjects.length > 0; d++) {
        for (let p = 0; p < periods && allSubjects.length > 0; p++) {
          for (let i = 0; i < allSubjects.length; i++) {
            const sid = allSubjects[i];
            const possTeachers = shuffleArray([...(teachersBySubject[sid] || [])]);
            
            let placedHere = false;
            for (const t of possTeachers) {
              if (canPlaceBase(sid, t.id, d, p)) {
                grid[d][p] = { subjectId: sid, teacherId: t.id };
                teacherOccupied[t.id][d][p] = true;
                perDaySubject[d][sid] = (perDaySubject[d][sid] || 0) + 1;
                
                // üÜï –û–±–Ω–æ–≤–ª—è–µ–º —Å—á—ë—Ç—á–∏–∫ –≥—Ä—É–ø–ø—ã
                const group = getSubjectGroup(sid);
                if (group) {
                  perDayGroup[d][group] = (perDayGroup[d][group] || 0) + 1;
                }
                
                allSubjects.splice(i, 1);
                placedHere = true;
                break;
              }
            }
            if (placedHere) break;
          }
        }
      }

      if (allSubjects.length > 0) {
        return null;
      }

      result[classId] = grid;
    }

    return result;
  }

  // –§–ê–ó–ê 2: –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–∞—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è
  function aggressiveOptimize(schedule) {
    console.log(`\nüî• –§–ê–ó–ê 2: –ê–ì–†–ï–°–°–ò–í–ù–ê–Ø –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è`);
    
    let totalSwaps = 0;
    
    for (const cls of classes) {
      const grid = schedule[cls.id];
      if (!grid) continue;
      
      const lessonsPerDay = Number(cls?.lessonsPerDay ?? 7);
      
      // –®–ê–ì 1: –§–∏–∑-—Ä–∞ –≤ –∫–æ–Ω–µ—Ü –¥–Ω—è
      for (let d = 0; d < DAYS; d++) {
        for (let p = 0; p < lessonsPerDay - 2; p++) {
          const lesson = grid[d][p];
          if (!lesson) continue;
          
          const physEd = ['culture', 'pe'];
          if (physEd.includes(lesson.subjectId)) {
            for (let p2 = lessonsPerDay - 1; p2 >= lessonsPerDay - 2; p2--) {
              const other = grid[d][p2];
              if (other && !physEd.includes(other.subjectId)) {
                if (canSwap(schedule, cls.id, d, p, d, p2)) {
                  [grid[d][p], grid[d][p2]] = [grid[d][p2], grid[d][p]];
                  totalSwaps++;
                  break;
                }
              }
            }
          }
        }
      }
      
      // –®–ê–ì 2: –°–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –∏–∑ –∫–æ–Ω—Ü–∞ –≤ —Å–µ—Ä–µ–¥–∏–Ω—É
      for (let d = 0; d < DAYS; d++) {
        for (let p = lessonsPerDay - 2; p < periods; p++) {
          const lesson = grid[d][p];
          if (!lesson) continue;
          
          const diff = bySubject[lesson.subjectId]?.difficulty;
          if (diff === 'hard') {
            for (let p2 = 1; p2 < lessonsPerDay - 2; p2++) {
              const other = grid[d][p2];
              if (other && bySubject[other.subjectId]?.difficulty !== 'hard') {
                if (canSwap(schedule, cls.id, d, p, d, p2)) {
                  [grid[d][p], grid[d][p2]] = [grid[d][p2], grid[d][p]];
                  totalSwaps++;
                  break;
                }
              }
            }
          }
        }
      }
      
      // –®–ê–ì 3: –ö–ª–∞—Å—Å–Ω—ã–π —á–∞—Å –≤ –∫–æ–Ω–µ—Ü
      for (let d = 0; d < DAYS; d++) {
        for (let p = 0; p < lessonsPerDay - 2; p++) {
          const lesson = grid[d][p];
          if (!lesson) continue;
          
          const endOfDay = ['class_hour', 'religion', 'global_comp'];
          if (endOfDay.includes(lesson.subjectId)) {
            for (let p2 = lessonsPerDay - 2; p2 < periods; p2++) {
              const other = grid[d][p2];
              if (other && !endOfDay.includes(other.subjectId)) {
                if (canSwap(schedule, cls.id, d, p, d, p2)) {
                  [grid[d][p], grid[d][p2]] = [grid[d][p2], grid[d][p]];
                  totalSwaps++;
                  break;
                }
              }
            }
          }
        }
      }
    }
    
    console.log(`‚ú® –°–¥–µ–ª–∞–Ω–æ –∑–∞–º–µ–Ω: ${totalSwaps}`);
  }

  function canSwap(schedule, classId, d1, p1, d2, p2) {
    const grid = schedule[classId];
    const lesson1 = grid[d1][p1];
    const lesson2 = grid[d2][p2];
    
    if (!lesson1 || !lesson2) return false;

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —É—á–∏—Ç–µ–ª–µ–π
    for (const cls of classes) {
      if (cls.id === classId) continue;
      const otherGrid = schedule[cls.id];
      if (!otherGrid) continue;

      if (otherGrid[d2]?.[p2]?.teacherId === lesson1.teacherId) return false;
      if (otherGrid[d1]?.[p1]?.teacherId === lesson2.teacherId) return false;
    }

    // ‚ùå –î–≤–∞ –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–∞ –ø–æ–¥—Ä—è–¥
    if (p1 > 0 && grid[d1][p1-1]?.subjectId === lesson2.subjectId) return false;
    if (p1 < periods-1 && grid[d1][p1+1]?.subjectId === lesson2.subjectId) return false;
    if (p2 > 0 && grid[d2][p2-1]?.subjectId === lesson1.subjectId) return false;
    if (p2 < periods-1 && grid[d2][p2+1]?.subjectId === lesson1.subjectId) return false;

    // üÜï ‚ùå –î–≤–∞ –ø—Ä–µ–¥–º–µ—Ç–∞ –∏–∑ –æ–¥–Ω–æ–π –≥—Ä—É–ø–ø—ã –ø–æ–¥—Ä—è–¥
    const group1 = getSubjectGroup(lesson1.subjectId);
    const group2 = getSubjectGroup(lesson2.subjectId);
    
    if (group2 && p1 > 0) {
      const prev = grid[d1][p1-1];
      if (prev && getSubjectGroup(prev.subjectId) === group2) return false;
    }
    if (group2 && p1 < periods-1) {
      const next = grid[d1][p1+1];
      if (next && getSubjectGroup(next.subjectId) === group2) return false;
    }
    if (group1 && p2 > 0) {
      const prev = grid[d2][p2-1];
      if (prev && getSubjectGroup(prev.subjectId) === group1) return false;
    }
    if (group1 && p2 < periods-1) {
      const next = grid[d2][p2+1];
      if (next && getSubjectGroup(next.subjectId) === group1) return false;
    }

    return true;
  }

  // –§–ê–ó–ê 3: –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞
  function evaluateQuality(schedule) {
    console.log(`\nüìä –§–ê–ó–ê 3: –û—Ü–µ–Ω–∫–∞ –∫–∞—á–µ—Å—Ç–≤–∞`);
    
    let totalScore = 0;
    
    for (const cls of classes) {
      const grid = schedule[cls.id];
      if (!grid) continue;

      const lessonsPerDay = Number(cls?.lessonsPerDay ?? 7);
      let violations = 0;
      let criticalViolations = 0;

      for (let d = 0; d < DAYS; d++) {
        for (let p = 0; p < lessonsPerDay; p++) {
          const lesson = grid[d][p];
          if (!lesson) continue;

          const diff = bySubject[lesson.subjectId]?.difficulty;
          
          // –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
          if (p >= lessonsPerDay - 2 && diff === 'hard') {
            violations += 3;
            criticalViolations++;
          }
          
          const physEd = ['culture', 'pe'];
          if (physEd.includes(lesson.subjectId) && p < lessonsPerDay - 2) {
            violations += 3;
            criticalViolations++;
          }
          
          // üÜï –î–≤–∞ —É—Ä–æ–∫–∞ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ –ø–æ–¥—Ä—è–¥
          if (p > 0) {
            const prev = grid[d][p-1];
            if (prev) {
              const group = getSubjectGroup(lesson.subjectId);
              const prevGroup = getSubjectGroup(prev.subjectId);
              if (group && group === prevGroup && group === 'math') {
                violations += 2;
                criticalViolations++;
              }
            }
          }
          
          // –°—Ä–µ–¥–Ω–∏–µ –Ω–∞—Ä—É—à–µ–Ω–∏—è
          if (p === lessonsPerDay - 1 && diff === 'normal') violations += 1;
          
          const endOfDay = ['class_hour', 'religion', 'global_comp'];
          if (endOfDay.includes(lesson.subjectId) && p < lessonsPerDay - 2) {
            violations += 1;
          }
        }
      }

      const score = Math.max(0, 100 - violations * 5);
      totalScore += score;
      
      let emoji = '‚úÖ';
      if (criticalViolations > 0) emoji = '‚ùå';
      else if (score < 80) emoji = '‚ö†Ô∏è';
      
      console.log(`   ${emoji} ${cls.name}: ${score}/100 (–∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö: ${criticalViolations})`);
    }

    const avgScore = Math.round(totalScore / classes.length);
    return { avgScore, totalScore };
  }

  // –û–°–ù–û–í–ù–û–ô –¶–ò–ö–õ
  let bestSchedule = null;
  let bestScore = 0;

  for (let attempt = 0; attempt < maxAttempts; attempt++) {
    if (Date.now() - start > timeLimitMs) break;

    console.log(`\n‚îÅ‚îÅ‚îÅ –ü–û–ü–´–¢–ö–ê ${attempt + 1}/${maxAttempts} ‚îÅ‚îÅ‚îÅ`);

    const base = generateBase();
    if (!base) {
      console.log(`‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å –±–∞–∑—É`);
      continue;
    }

    aggressiveOptimize(base);
    const { avgScore, totalScore } = evaluateQuality(base);

    if (avgScore > bestScore) {
      bestScore = avgScore;
      bestSchedule = base;
      console.log(`\nüèÜ –ù–û–í–´–ô –õ–£–ß–®–ò–ô –†–ï–ó–£–õ–¨–¢–ê–¢: ${avgScore}/100`);
    }

    if (avgScore >= 95) {
      console.log(`\nüéâ –ò–î–ï–ê–õ–¨–ù–û–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï!`);
      break;
    }

    if (avgScore >= 85 && attempt >= 10) {
      console.log(`\n‚úÖ –î–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ö–æ—Ä–æ—à–µ–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ`);
      break;
    }
  }

  if (bestSchedule) {
    const duration = Math.round((Date.now() - start) / 1000);
    console.log(`\n‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó`);
    console.log(`‚ïë  üéâ –†–ê–°–ü–ò–°–ê–ù–ò–ï –ì–û–¢–û–í–û!            ‚ïë`);
    console.log(`‚ïë  –ö–∞—á–µ—Å—Ç–≤–æ: ${bestScore}/100                  ‚ïë`);
    console.log(`‚ïë  –í—Ä–µ–º—è: ${duration}—Å                         ‚ïë`);
    console.log(`‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù`);
    
    console.log(`\n‚úÖ –ü—Ä–∏–º–µ–Ω–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞:`);
    console.log(`   üßÆ –ù–ï–¢ –º–∞—Ç–µ–º–∞—Ç–∏–∫–∏ (–∞–ª–≥–µ–±—Ä–∞+–≥–µ–æ–º–µ—Ç—Ä–∏—è) –ø–æ–¥—Ä—è–¥`);
    console.log(`   üèÉ –§–∏–∑-—Ä–∞ –¢–û–õ–¨–ö–û –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è`);
    console.log(`   üß† –°–ª–æ–∂–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã –Ω–∞ 2-4 —É—Ä–æ–∫–∞—Ö`);
    console.log(`   üò¥ –ù–ï–¢ —Å–ª–æ–∂–Ω—ã—Ö –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è`);
    console.log(`   üìö –ö–ª–∞—Å—Å–Ω—ã–π —á–∞—Å –≤ –∫–æ–Ω—Ü–µ –¥–Ω—è`);
    
    return bestSchedule;
  }

  console.warn('\n‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ');
  return null;
}